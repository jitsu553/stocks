/**
 * Created with JetBrains WebStorm.
 * User: sujit
 * Date: 1/1/16
 * Time: 1:06 PM
 * To change this template use File | Settings | File Templates.
 */


stocks=function(){

    var stocks=
    {
     version:"0.0"
    };

    allocation={};

    allocation.create = function(Customers,source){
     var readyCustomerName=[];
     var readyResourceName=[];
     Customers.forEach(function(id){
         readyCustomerName.push(id.name);
     }) ;

     source.forEach(function(id){
            readyResourceName.push(id.name);
     });


        var CustomerGraph= Customerjsonid(Customers);
        var ResourceGraph= Resourcejsonid(source);
        var finalCustomer=[];
        while(readyCustomerName.length) {
        sort(CustomerGraph,readyCustomerName);
            var TopCustomer=CustomerGraph[readyCustomerName.pop()];
            var TopCustomerfinal=Sourceallotment(ResourceGraph,TopCustomer);
            finalCustomer.push(TopCustomerfinal);
        }
        //console.log(finalCustomer);
       return finalCustomer;
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  var  sort = function(Customers,readyCustomerName){
      readyCustomerName.sort(function(a, b) {
          var ta = Customers[a], tb = Customers[b];
           ta.orderedtime=new Date(ta.orderedtime)//.getTime();
          tb.orderedtime=new Date(tb.orderedtime)//.getTime();
          if (tb.orderedtime && (!ta.orderedtime || tb.orderedtime < ta.orderedtime)) {
              return -1;
          }
          if (ta.orderedtime && (!tb.orderedtime || ta.orderedtime < tb.orderedtime)) {
              return 1;
          }
          return 0;
      });
    };
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var Customerjsonid= function(Customers){
            var CustomerGraph ={};
        for (var i = 0, len = Customers.length; i < len; i++) {
            var t = Customers[i];
            CustomerGraph[t.name] = {
                name: t.name,
                quantity: t.quantity,
                orderedtime: t.orderedtime,
                source: t.source
            };

        }
        return CustomerGraph ;
    };

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var Resourcejsonid=  function(source) {
        var ResourceGraph ={};
        for (var i = 0, len = source.length; i < len; i++) {
            var t = source[i];
            ResourceGraph[t.name] = {
                name: t.name,
                availability: t.availability
            };

        }
        return ResourceGraph ;
    };


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var Sourceallotment = function(ResourceGraph,TopCustomer){

        if(ResourceGraph[TopCustomer.source].availability>0){
           // console.log(TopCustomer);

            if((ResourceGraph[TopCustomer.source].availability)>=(TopCustomer.quantity)){
               TopCustomer.allotedsource=TopCustomer.quantity;
                ResourceGraph[TopCustomer.source].availability=ResourceGraph[TopCustomer.source].availability-TopCustomer.quantity;
                TopCustomer.allotmentstatus='true';
            }
            else{
                TopCustomer.allotedsource=ResourceGraph[TopCustomer.source].availability;
                ResourceGraph[TopCustomer.source].availability=0;
                TopCustomer.allotmentstatus='partially true';

            };


        }
        else
        {
            TopCustomer.allotedsource=0;
            TopCustomer.allotmentstatus='false';


        }
          return TopCustomer;
    };
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}() ;
